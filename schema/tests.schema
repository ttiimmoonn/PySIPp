{
  "$schema" : "http://json-schema.org/draft-04/schema#",
  "title" : "Schema for autotest kit",

  "definitions" : {
      "users" : {
          "type" : "object",
          "properties" : {
              "UserId" : {"type" : "integer", "minimum" : 0, "exclusiveMinimum" : false},
              "Number" : {"type" : "string", "minLength" : 1},
              "Login" : {"type" : "string", "minLength" : 1},
              "Password" : {"type" : "string", "minLength" : 1},
              "SipDomain" : {"type" : "string", "minLength" : 1},
              "SipGroup" : {"type" : "string", "minLength" : 1},
              "Port" : {"type" : "integer", "minimum" : 1024, "maximum" : 65536, "exclusiveMinimum" : false, "exclusiveMaximum" : false},
              "Expires" : {"type" : "integer", "minimum" : 0, "maximum" : 3600, "exclusiveMinimum" : false, "exclusiveMaximum" : false},
              "QParam" : {"type" : "number", "minimum" : 0, "maximum" : 1, "exclusiveMinimum" : false, "exclusiveMaximum" : false},
              "OneTime" : {"type" : "boolean"},
              "UserIP" : {"type" : "string", "minLength" : 7, "maxLength" : 15},
              "FakePort" : {"type" : "integer", "minimum" : 1024, "maximum" : 65536, "exclusiveMinimum" : false, "exclusiveMaximum" : false},
              "RtpPort" : {"type" : "integer","minimum" : 1024, "maximum" : 65536, "exclusiveMinimum" : false, "exclusiveMaximum" : false},
              "SipTransport" : {"type" : "string", "enum" : ["UDP", "TCP"]},
              "Mode" : {"type" : "string", "enum" : ["Auto", "Manual"]},
              "BindPort" : {"type" : "integer", "minimum" : 1024, "maximum" : 65536, "exclusiveMinimum" : false, "exclusiveMaximum" : false}   
          },
          "required" : ["UserId", "Number", "Login", "Password", "SipDomain", "SipGroup", "Port"]
      },
      "uservar" : {
          "type" : "object",
          "patternProperties" : {
              "^%%.*%%$" : {"type" : "string", "minLength" : 1}
          },
          "additionalProperties": false  
      },
      "conf" : {
          "type" : "object",
          "patternProperties" : {
               "^command[\\d]+$" : {"type" : "string", "minLength" : 1}
           },
           "additionalProperties": false 
       },
       "commands" : {
       	   "type" : "object",
       	   "properties" : {
       	       "SourceFile" : {"type" : "string", "minLength" : 1},
       	       "Options" : {"type" : "string", "minLength" : 1},
       	       "SippType" : {"type" : "string", "enum" : ["uas","uac"]},
               "NeedAuth" : {"type" : "boolean"},
               "NoTimeOutError" : {"type" : "boolean"},
       	       "Timeout" : {"type" : "string", "pattern" : "^\\d+[s]$"}	  
       	   },
       	   "required" : ["SourceFile", "SippType", "Options"]
       }
  },

  "type" : "object",
  "properties" : {
      "TestName" : {"type" : "string", "minLength" : 1},
      "AutoTest" : {"type" : "boolean"},
      "Users" : { 
          "type" : "array",
          "items" : {"$ref" : "#/definitions/users"}
      },
      "UserVar" : {
          "type" : "array",
          "items" : {"$ref" : "#/definitions/uservar"}
      },
      "PreConf" : {
          "type" : "array",
          "items" : {"$ref" : "#/definitions/conf"}
      },
      "PostConf" : {
          "type" : "array",
          "items" : {"$ref" : "#/definitions/conf"}
      },
      "Tests" : {
          "type" : "array",
          "items" : {
              "type" : "object",
              "properties" : {
                  "Name" : {"type" : "string", "minLength" : 1},
                  "Description" : {"type" : "string", "minLength" : 1},
                  "TestProcedure" : {
                      "type" : "array",
                      "items" : {
                          "oneOf" : [
                              {
                                 "type" : "object",
                                 "properties" : {
                                     "StartUA" : {
                                          "type" : "array",
                                          "items" : {
                                              "type" : "object",
                                              "properties" : {
                                                  "Type" : {"type" : "string", "enum" : ["User", "Trunk"]},
                                                  "UserId" : {"type" : "integer" , "minimum" : 0, "exclusiveMinimum" : false},
                                                  "Port" : {"type" : "integer", "minimum" : 0, "maximum" : 65536, "exclusiveMinimum" : false, "exclusiveMaximum" : false},
                                                  "WriteStat" : {"type" : "boolean"},
                                                  "Name" : {"type" : "string", "minLength" : 1},
                                                  "Cyclic" : {"type" : "boolean"},
                                                  "BackGround" : {"type" : "boolean"},
                                                  "Commands" : {
                   	                                  "type" : "array",
                   	                                  "items" : {"$ref" : "#/definitions/commands"} 
                                                  }
                                              },
                                              "required" : ["Type", "Name", "Commands"],
                                              "oneOf" : [
                                              {
                                                  "properties" : {
                                                      "Type" : {"enum" : ["User"]}
                                                  },
                                                  "required" : ["UserId"]
                                              },
                                              {
                                                  "properties" : {
                                                       "Type" : {"enum" : ["Trunk"]}
                                                  },
                                                  "required" : ["Port"]
                                              }
                                              ]
                                          }
                                     }
                                 },
                                 "required" : ["StartUA"]
                              },
                              {
                              	"type" : "object",
                              	"properties" : {
                                    "CheckRetransmission" : {
                                    	"type" : "array",
                                    	"items" : {
                                            "type" : "object",
                                            "properties" : {
                                            	"Timer" : {"type" : "string", "enum" : ["A","B","E","F","G","H"]},
                                            	"UA" : {"type" : "string", "pattern" : "^[0-9]{1,2}$|^([0-9]{1,2},)+[0-9]{1,2}$"},
                                            	"Msg" : {
                                            	    "type" : "array",
                                            	    "items" : {
                                            	    	"type" : "object",
                                            	    	"properties" : {
                                            	    		"MsgType" : {"type" : "string", "enum" : ["request", "response"]},
                                            	    		"Method" : {"type" : "string", "minLength": 1}
                                            	    	},
                                            	    	"required" : ["MsgType", "Method"],
                                                    "oneOf" : [
                                                        {
                                                            "properties" : {
                                                                "MsgType" : {"enum" : ["request"]},
                                                                "Code" : {"type" : "null"}
                                                            },
                                                            "required" : ["Code"]
                                                        },
                                                        {
                                                            "properties" : {
                                                                "MsgType" : {"enum" : ["response"]},
                                                                "Code" : {"type" : "integer", "minimum" : 100, "maximum" : 699, "exclusiveMinimum" : false, "exclusiveMaximum" : false} 
                                                            },
                                                            "required" : ["Code"] 
                                                        }
                                                    ]
                                            	    }
                                                }
                                            },
                                            "required" : ["Timer", "UA", "Msg"]
                                    	}
                                    }
                                },
                                "required" : ["CheckRetransmission"]
                              },
                              {
                              	"type" : "object",
                              	"properties" : {
                              		"CheckDifference" : {
                                        "type" : "array",
                                        "items" : {
                                        	"type" : "object",
                                        	"properties" : {
                                        		"Mode" : {"type" : "string", "enum" : ["between_ua","inner_ua"]},
                                        		"UA" : {"type" : "string", "pattern" : "^[0-9]{1,2}$|^([0-9]{1,2},)+[0-9]{1,2}$"},
                                        		"Difference" : {
                                        		    "oneOf" : [
                                                    {"type" : "number", "minimum" : 0, "exclusiveMinimum" : false},
                                                    {"type" : "string", "pattern" : "^%%[a-zA-Z-0-9_]+%%$"}
                                        		    ]
                                        		},
                                                "Msg" : {
                                                	"type" : "array",
                                                	"items" : {
                                                		"type" : "object",
                                                		"properties" : {
                                                			"MsgType" : {"type" : "string", "enum" : ["request", "response"]},
                                                			"Method" : {"type" : "string", "minLength" : 1}
                                                      },
                                                      "required" : ["MsgType", "Method"],
                                                		  "oneOf" : [
                                                          {
                                                              "properties" : {
                                                                 "MsgType" : {"enum" : ["request"]},
                                                                 "Code" : {"type" : "null"}
                                                               },
                                                               "required" : ["Code"] 
                                                          },
                                                          {
                                                               "properties" : {
                                                                   "MsgType" : {"enum" : ["response"]},
                                                                   "Code" : {"type" : "integer", "minimum" : 100, "maximum" : 699, "exclusiveMinimum" : false, "exclusiveMaximum" : false} 
                                                               },
                                                               "required" : ["Code"] 
                                                          }
                                                      ]
                                                	}
                                                }
                                        	},
                                        	"required" : ["Mode", "UA", "Msg"]
                                        }
                              		}
                              	},
                              	"required" : ["CheckDifference"]
                              },
                              {
                              	"type" : "object",
                              	"properties" : {
                              		"Sleep" : {"type" : "integer", "minimum" : 0, "exclusiveMinimum" : false}
                              	},
                              	"required" : ["Sleep"]
                              },
                              {
                              	"type" : "object",
                              	"properties" : {
                              	    "ServiceFeature" : {
                                        "type" : "array",
                                        "items" : {
                                            "type" : "object",
                                            "properties" : {
                                                "code" : {"type" : "string", "minLength" : 1},
                                                "userId" : {"type" : "integer", "minimum" : 0, "exclusiveMinimum" : false}
                                            },
                                            "required" : ["code", "userId"] 
                                        } 
                                    }
                              	},
                              	"required" : ["ServiceFeature"]
                              },
                              {
                              	"type" : "object",
                              	"properties" : {
                              	    "ManualReg" : {
                              			    "type" : "object",
                                            "patternProperties" : {
                                                "^\\d+$" : {
                                                "type" : "object",
                                                "properties" : {
                                                    "script" : {"type" : "string", "minLength" : 1},
                                                    "need_drop" : {"type" : "boolean"}
                                                },
                                                "required" : ["script"]
                                            }
                                        },
                                        "additionalProperties": false
                                    }
                              	},
                              	"required" : ["ManualReg"]
                              },
                              {
                                "type" : "object",
                                "properties" : {
                                    "DropManualReg" : {
                                        "type" : "array",
                                        "items" : {
                                            "type" : "string",
                                            "pattern" : "^\\d+$"
                                        }
                                    }
                                },
                                "required" : ["DropManualReg"] 
                              }
                          ]	
                      }
                  }
              },
              "required" : ["TestProcedure"]
          }
      } 
   },
   "required" : ["TestName", "Tests"]
}
